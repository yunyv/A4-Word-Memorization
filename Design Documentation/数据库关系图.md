
# 数据库关系图

## 新表结构关系图

```mermaid
erDiagram
    Users {
        Int id PK "自增主键"
        String token UK "VARCHAR(64) 唯一"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    Wordlists {
        Int id PK "自增主键"
        Int userId FK "外键关联Users.id"
        String name "VARCHAR(100) 必填"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    Words {
        Int id PK "自增主键"
        String wordText UK "VARCHAR(100) 唯一"
        String? pronunciation "VARCHAR(200) 可选"
        Json? definitionData "JSON 可选(备份用)"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    WordPronunciations {
        Int id PK "自增主键"
        Int wordId FK "外键关联Words.id"
        String type "VARCHAR(20) 必填"
        String phonetic "VARCHAR(100) 必填"
        String? audioUrl "TEXT 可选"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    WordDefinitions {
        Int id PK "自增主键"
        Int wordId FK "外键关联Words.id"
        String type "VARCHAR(30) 必填"
        String? partOfSpeech "VARCHAR(50) 可选"
        Int order "INT 默认0"
        String? meaning "TEXT 可选"
        String? chineseMeaning "TEXT 可选"
        String? englishMeaning "TEXT 可选"
        Int? definitionNumber "INT 可选"
        String? linkedWords "TEXT 可选(JSON数组)"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    DefinitionExamples {
        Int id PK "自增主键"
        Int definitionId FK "外键关联WordDefinitions.id"
        Int order "INT 默认0"
        String english "TEXT 必填"
        String? chinese "TEXT 可选"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    DefinitionIdioms {
        Int id PK "自增主键"
        Int definitionId FK "外键关联WordDefinitions.id"
        Int order "INT 默认0"
        String title "VARCHAR(200) 必填"
        String meaning "TEXT 必填"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    IdiomExamples {
        Int id PK "自增主键"
        Int idiomId FK "外键关联DefinitionIdioms.id"
        Int order "INT 默认0"
        String english "TEXT 必填"
        String? chinese "TEXT 可选"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    WordSentences {
        Int id PK "自增主键"
        Int wordId FK "外键关联Words.id"
        Int order "INT 默认0"
        String english "TEXT 必填"
        String? chinese "TEXT 可选"
        String? audioUrl "TEXT 可选"
        String? source "VARCHAR(200) 可选"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    WordForms {
        Int id PK "自增主键"
        Int wordId FK "外键关联Words.id"
        String formType "VARCHAR(50) 必填"
        String formWord "VARCHAR(100) 必填"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    WordlistEntries {
        Int id PK "自增主键"
        Int wordlistId FK "外键关联Wordlists.id"
        Int wordId FK "外键关联Words.id"
    }

    UserWordProgress {
        Int id PK "自增主键"
        Int userId FK "外键关联Users.id"
        Int wordId FK "外键关联Words.id"
        Int reviewStage "INT 默认0"
        DateTime nextReviewDate "DATE 必填"
        DateTime? lastReviewedAt "DATETIME(3) 可选"
        DateTime createdAt "DATETIME(3) 默认当前时间"
        DateTime updatedAt "DATETIME(3) 自动更新"
    }

    %% 关系定义
    Users ||--o{ Wordlists : "拥有"
    Users ||--o{ UserWordProgress : "学习进度"
    
    Wordlists ||--o{ WordlistEntries : "包含"
    WordlistEntries }o--|| Words : "包含"
    
    Words ||--o{ WordPronunciations : "发音"
    Words ||--o{ WordDefinitions : "释义"
    Words ||--o{ WordSentences : "例句"
    Words ||--o{ WordForms : "词形变化"
    Words ||--o{ WordlistEntries : "属于"
    Words ||--o{ UserWordProgress : "学习进度"
    
    WordDefinitions ||--o{ DefinitionExamples : "例句"
    WordDefinitions ||--o{ DefinitionIdioms : "习语"
    
    DefinitionIdioms ||--o{ IdiomExamples : "例句"
```

## 表结构说明

### 主要表关系

1. **用户相关表**
   - `Users`：用户基本信息
   - `Wordlists`：用户创建的词书
   - `UserWordProgress`：用户学习进度

2. **单词相关表**
   - `Words`：单词基本信息（保留原JSON字段作为备份）
   - `WordPronunciations`：单词发音（美式/英式）
   - `WordDefinitions`：单词释义（多种类型）
   - `WordSentences`：单词例句
   - `WordForms`：词形变化

3. **释义相关表**
   - `DefinitionExamples`：释义中的例句
   - `DefinitionIdioms`：释义中的习语
   - `IdiomExamples`：习语中的例句

4. **关联表**
   - `WordlistEntries`：词书与单词的多对多关系

### 字段约束说明

#### Users 表
- `id`: Int, 主键, 自增
- `token`: String(64), 唯一, 必填, 用户身份标识
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### Wordlists 表
- `id`: Int, 主键, 自增
- `userId`: Int, 外键, 必填, 关联Users表
- `name`: String(100), 必填, 词书名称
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### Words 表
- `id`: Int, 主键, 自增
- `wordText`: String(100), 唯一, 必填, 单词文本
- `pronunciation`: String(200), 可选, 发音信息
- `definitionData`: Json, 可选, 原始JSON数据（备份用）
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### WordPronunciations 表
- `id`: Int, 主键, 自增
- `wordId`: Int, 外键, 必填, 关联Words表
- `type`: String(20), 必填, 发音类型('american'|'british')
- `phonetic`: String(100), 必填, 音标
- `audioUrl`: Text, 可选, 音频URL
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### WordDefinitions 表
- `id`: Int, 主键, 自增
- `wordId`: Int, 外键, 必填, 关联Words表
- `type`: String(30), 必填, 释义类型('basic'|'web'|'authoritative'|'bilingual'|'english')
- `partOfSpeech`: String(50), 可选, 词性
- `order`: Int, 必填, 默认0, 释义顺序
- `meaning`: Text, 可选, 基本释义和网络释义使用
- `chineseMeaning`: Text, 可选, 权威英汉释义使用
- `englishMeaning`: Text, 可选, 权威英汉释义使用
- `definitionNumber`: Int, 可选, 权威英汉释义使用
- `linkedWords`: Text, 可选, 英英释义使用(JSON数组)
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### DefinitionExamples 表
- `id`: Int, 主键, 自增
- `definitionId`: Int, 外键, 必填, 关联WordDefinitions表
- `order`: Int, 必填, 默认0, 例句顺序
- `english`: Text, 必填, 英文例句
- `chinese`: Text, 可选, 中文翻译
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### DefinitionIdioms 表
- `id`: Int, 主键, 自增
- `definitionId`: Int, 外键, 必填, 关联WordDefinitions表
- `order`: Int, 必填, 默认0, 习语顺序
- `title`: String(200), 必填, 习语标题
- `meaning`: Text, 必填, 习语释义
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### IdiomExamples 表
- `id`: Int, 主键, 自增
- `idiomId`: Int, 外键, 必填, 关联DefinitionIdioms表
- `order`: Int, 必填, 默认0, 例句顺序
- `english`: Text, 必填, 英文例句
- `chinese`: Text, 可选, 中文翻译
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### WordSentences 表
- `id`: Int, 主键, 自增
- `wordId`: Int, 外键, 必填, 关联Words表
- `order`: Int, 必填, 默认0, 例句顺序
- `english`: Text, 必填, 英文例句
- `chinese`: Text, 可选, 中文翻译
- `audioUrl`: Text, 可选, 音频URL
- `source`: String(200), 可选, 例句来源
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### WordForms 表
- `id`: Int, 主键, 自增
- `wordId`: Int, 外键, 必填, 关联Words表
- `formType`: String(50), 必填, 词形类型('plural'|'past_tense'等)
- `formWord`: String(100), 必填, 词形单词
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

#### WordlistEntries 表
- `id`: Int, 主键, 自增
- `wordlistId`: Int, 外键, 必填, 关联Wordlists表
- `wordId`: Int, 外键, 必填, 关联Words表

#### UserWordProgress 表
- `id`: Int, 主键, 自增
- `userId`: Int, 外键, 必填, 关联Users表
- `wordId`: Int, 外键, 必填, 关联Words表
- `reviewStage`: Int, 必填, 默认0, 复习阶段
- `nextReviewDate`: Date, 必填, 下次复习日期
- `lastReviewedAt`: DateTime, 可选, 最后复习时间
- `createdAt`: DateTime, 必填, 默认当前时间
- `updatedAt`: DateTime, 必填, 自动更新

### 索引策略

1. **唯一索引**
   - `Words.word_text`: 单词文本唯一性
   - `Users.token`: 用户令牌唯一性
   - `WordPronunciations.word_id + type`: 单词发音类型唯一性
   - `WordForms.word_id + form_type`: 单词词形类型唯一性
   - `WordlistEntries.wordlist_id + word_id`: 词书条目唯一性
   - `UserWordProgress.user_id + word_id`: 用户单词进度唯一性

2. **普通索引**
   - `WordDefinitions.word_id + type`: 单词释义类型查询优化
   - `WordSentences.word_id`: 单词例句查询优化
   - `DefinitionExamples.definition_id`: 释义例句查询优化
   - `DefinitionIdioms.definition_id`: 释义习语查询优化
   - `IdiomExamples.idiom_id`: 习语例句查询优化

### Prisma 配置说明

#### 表名映射关系
- Prisma模型名使用PascalCase（如User、Wordlist）
- 数据库表名使用自定义映射（如Users、Wordlists）
- 使用`@@map()`指令指定数据库表名

#### 字段映射关系
- Prisma字段名使用camelCase（如userId、wordText）
- 数据库字段名使用snake_case（如user_id、word_text）
- 使用`@map()`指令指定数据库字段名
- 时间字段自动映射为created_at、updated_at

#### 级联删除策略
- 所有外键关系都使用`onDelete: Cascade`
- 删除用户时自动删除其词书和学习进度
- 删除词书时自动删除其包含的单词条目
- 删除单词时自动删除其所有相关数据（发音、释义、例句等）
- 删除释义时自动删除其例句和习语
- 删除习语时自动删除其例句

### 数据库配置

#### 数据库连接
- 数据库类型：MySQL 8.0
- 连接字符串通过环境变量`DATABASE_URL`配置
- 使用Prisma作为ORM工具
- 字符集：utf8mb4，支持完整的Unicode字符集

### API查询模式示例

#### 1. 单词查询API
```typescript
// 通过单词文本获取单词ID - GET /api/words/by-text?text=example
const word = await db.word.findUnique({
  where: { 
    wordText: text.trim().toLowerCase() 
  },
  select: {
    id: true
  }
});
```

#### 2. 词书管理API
```typescript
// 获取用户所有词书 - GET /api/wordlists
const wordlists = await db.wordlist.findMany({
  where: { userId: user.id },
  include: {
    _count: {
      select: { wordlistEntries: true }
    }
  },
  orderBy: { createdAt: 'desc' }
});
```

#### 3. 复习进度API
```typescript
// 获取待复习单词 - GET /api/review/due
const dueWords = await db.userWordProgress.findMany({
  where: {
    userId: user.id,
    nextReviewDate: {
      lte: new Date()
    }
  },
  include: {
    word: {
      select: {
        wordText: true
      }
    }
  },
  orderBy: {
    nextReviewDate: 'asc'
  },
  take: limit
});
```

#### 4. 单词详情查询
```typescript
// 从新表结构获取完整单词数据 - GET /api/dictionary?word=example
const word = await db.word.findUnique({
  where: { wordText: wordText.toLowerCase() }
});

const pronunciations = await db.$queryRaw`
  SELECT * FROM WordPronunciations WHERE word_id = ${word.id}
`;

const definitions = await db.$queryRaw`
  SELECT * FROM WordDefinitions WHERE word_id = ${word.id} ORDER BY type, \`order\`
`;
```

### 数据转换逻辑说明

#### 1. 表结构到JSON的转换
```typescript
// 将表结构数据转换为原有JSON格式
function convertTablesToJson(word: {
  pronunciation?: string | null;
  pronunciations?: unknown[];
  definitions?: unknown[];
  sentences?: unknown[];
  wordForms?: unknown[];
  definitionExamples?: unknown[];
  definitionIdioms?: unknown[];
  idiomExamples?: unknown[];
}): WordDefinitionData | null {
  const result: WordDefinitionData = {
    pronunciation: word.pronunciation || undefined,
    definitions: {
      basic: [],
      web: []
    },
    pronunciationData: {},
    sentences: [],
    authoritativeDefinitions: [],
    bilingualDefinitions: [],
    englishDefinitions: [],
    wordForms: []
  };

  // 处理发音数据
  if (word.pronunciations && word.pronunciations.length > 0) {
    word.pronunciations.forEach((pron) => {
      const typedPron = pron as { type: string; phonetic: string; audioUrl: string };
      if (typedPron.type === 'american') {
        result.pronunciationData!.american = {
          phonetic: typedPron.phonetic,
          audioUrl: typedPron.audioUrl
        };
      } else if (typedPron.type === 'british') {
        result.pronunciationData!.british = {
          phonetic: typedPron.phonetic,
          audioUrl: typedPron.audioUrl
        };
      }
    });
  }

  // 处理释义数据...
  // 处理例句数据...
  // 处理词形变化...

  return result;
}
```

#### 2. Prisma JSON值转换
```typescript
// 将复杂对象转换为 Prisma 可接受的 JsonValue 类型
function convertToPrismaJson(data: unknown) {
  if (data === null || data === undefined) {
    return null;
  }

  try {
    // 将对象转换为 JSON 字符串，然后再解析回来
    // 这样可以确保对象结构符合 Prisma 的 Json 字段要求
    return JSON.parse(JSON.stringify(data));
  } catch (error) {
    console.error('转换对象为 Prisma JSON 时出错:', error);
    return null;
  }
}
```

### 事务使用场景说明

#### 1. 词书上传事务
```typescript
// 上传新词书时使用事务确保数据一致性
const result = await db.$transaction(async (tx) => {
  // 查找或创建单词记录
  const wordIds: number[] = [];
  
  for (const wordText of uniqueWords) {
    // 尝试查找现有单词
    let word = await tx.word.findUnique({
      where: { wordText }
    });

    // 如果不存在，创建新单词
    if (!word) {
      word = await tx.word.create({
        data: {
          wordText,
          definitionData: {}
        }
      });
    }

    wordIds.push(word.id);
  }

  // 创建词书记录
  const newWordlist = await tx.wordlist.create({
    data: {
      userId: userId,
      name: name.trim()
    }
  });

  // 批量创建关联记录
  const entriesToCreate = wordIds.map(wordId => ({
    wordlistId: newWordlist.id,
    wordId
  }));

  await tx.wordlistEntry.createMany({
    data: entriesToCreate
  });

  return {
    id: newWordlist.id,
    name: newWordlist.name,
    wordCount: uniqueWords.length
  };
});
```

#### 2. 数据迁移事务
```typescript
// 迁移单词数据时使用事务确保数据完整性
await prisma.$transaction(async (tx) => {
  // 1. 更新基本发音信息
  if (definitionData.pronunciation) {
    await tx.$executeRaw`UPDATE Words SET pronunciation = ${definitionData.pronunciation} WHERE id = ${word.id}`;
  }

  // 2. 迁移发音数据
  if (definitionData.pronunciationData) {
    await migratePronunciationData(tx, word.id, definitionData.pronunciationData);
  }

  // 3. 迁移释义数据
  if (definitionData.definitions) {
    await migrateDefinitionData(tx, word.id, definitionData.definitions);
  }

  // 其他数据迁移...
});
```

### 数据库演进历史

#### 第一阶段：基础表结构（2025-10-15）
- 创建了基础的5张表：Users、Wordlists、Words、WordlistEntries、UserWordProgress
- 使用JSON字段存储单词完整定义数据
- 建立了基本的用户-词书-单词关系

**迁移文件：** `20251015121615_init/migration.sql`
- 创建了所有基础表结构
- 设置了外键约束和级联删除
- 建立了必要的唯一索引

#### 第二阶段：结构化数据扩展（2025-10-16）
- 将JSON数据拆分为多个关联表
- 新增了7张详细表：WordPronunciations、WordDefinitions、DefinitionExamples、DefinitionIdioms、IdiomExamples、WordSentences、WordForms
- 保留了原JSON字段作为备份
- 建立了完整的索引策略

**迁移文件：** `20251016053913_add_word_details_tables/migration.sql`
- 修改了Words表，添加pronunciation字段，将definitionData改为可选
- 创建了所有新的详细表结构
- 设置了外键约束和索引

#### 从JSON到结构化数据的演进说明

1. **演进动机**
   - JSON字段虽然灵活，但查询效率低，无法建立有效索引
   - 无法进行复杂的关系查询和数据统计
   - 数据一致性和完整性难以保证
   - 不利于数据分析和报表生成

2. **演进策略**
   - 保留原JSON字段作为备份，确保向后兼容
   - 创建结构化表存储相同的数据
   - 实现双向转换逻辑，支持数据格式互转
   - 优先从新表结构查询，JSON作为后备数据源

3. **数据迁移流程**
   ```mermaid
   flowchart TD
       A[开始] --> B[获取所有有JSON数据的单词]
       B --> C[逐个处理单词]
       C --> D[解析JSON数据]
       D --> E[使用事务迁移数据]
       E --> F[验证数据完整性]
       F --> G{迁移成功?}
       G -->|是| H[记录成功日志]
       G -->|否| I[记录错误信息]
       H --> J[下一个单词]
       I --> J
       J --> K{还有单词?}
       K -->|是| C
       K -->|否| L[输出迁移统计]
       L --> M[完成]
   ```

4. **迁移脚本实现**
   - 脚本位置：`scripts/migrate-word-data.ts`
   - 支持增量迁移，避免重复处理
   - 详细的错误日志和统计信息
   - 支持断点续传和错误恢复

5. **API兼容性处理**
   - API路由同时支持新旧两种数据结构
   - 优先从新表结构查询数据
   - 当新表数据不完整时，回退到JSON字段
   - 自动将新数据同时保存到两种格式

### 查询优化

1. **查询单词基本信息**
   ```sql
   SELECT w.*, p.phonetic, p.audio_url 
   FROM Words w 
   LEFT JOIN WordPronunciations p ON w.id = p.word_id 
   WHERE w.word_text = 'example';
   ```

2. **查询单词释义**
   ```sql
   SELECT d.*, e.english, e.chinese 
   FROM WordDefinitions d 
   LEFT JOIN DefinitionExamples e ON d.id = e.definition_id 
   WHERE d.word_id = ? AND d.type = 'authoritative';
   ```

3. **查询单词例句**
   ```sql
   SELECT english, chinese, audio_url, source 
   FROM WordSentences 
   WHERE word_id = ? 
   ORDER BY order;
   ```

4. **复杂关联查询**
   ```sql
   -- 获取用户词书中的所有单词及其学习进度
   SELECT 
     w.word_text,
     p.review_stage,
     p.next_review_date,
     p.last_reviewed_at
   FROM Users u
   JOIN Wordlists wl ON u.id = wl.user_id
   JOIN WordlistEntries we ON wl.id = we.wordlist_id
   JOIN Words w ON we.word_id = w.id
   LEFT JOIN UserWordProgress p ON w.id = p.word_id AND p.user_id = u.id
   WHERE u.id = ? AND wl.id = ?
   ORDER BY p.next_review_date ASC;
   ```

### 性能优化建议

1. **索引优化**
   - 为常用查询字段创建复合索引
   - 定期分析查询性能，优化索引策略
   - 使用EXPLAIN分析慢查询

2. **查询优化**
   - 避免N+1查询问题，使用include或join
   - 合理使用分页，避免一次性加载大量数据
   - 对于复杂统计查询，考虑使用缓存

3. **数据归档**
   - 定期清理过期的学习进度数据
   - 对于不常用的历史数据，考虑归档处理
   - 定期优化表结构，重建索引

### 数据备份与恢复

1. **备份策略**
   - 每日自动备份数据库
   - 重要操作前手动备份
   - 保留最近30天的备份文件

2. **恢复流程**
   - 停止应用服务
   - 恢复数据库备份
   - 验证数据完整性
   - 重启应用服务

3. **灾难恢复**
   - 建立异地备份机制
   - 定期测试恢复流程
   - 制定详细的应急响应计划